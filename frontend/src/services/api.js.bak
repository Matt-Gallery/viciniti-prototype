import axios from 'axios';
import { AuthResponse, User, Service, ServiceProvider, Appointment, AppointmentCreateRequest, ServiceCreateRequest, UserRegisterRequest, ApiService, ApiAppointment, ServiceCategory, TimeBlock } from '../types';

const API_URL = process.env.REACT_APP_API_URL || 'http://localhost:8000/api';

const api = axios.create({
    baseURL: API_URL,
    headers: {
        'Content-Type': 'application/json',
    },
});

// Add token to requests if it exists
api.interceptors.request.use((config) => {
    const token = localStorage.getItem('token');
    console.log('API Request to:', config.url);
    console.log('Token exists:', !!token);
    
    if (token) {
        config.headers.Authorization = `Token ${token}`;
        console.log('Authorization header set:', config.headers.Authorization);
    }
    return config;
});

export const auth = {
    login: (username, password) =>
        api.post('/auth/login/', { username, password }),
    
    register: (userData) =>
        api.post('/auth/register/', userData),
    
    logout: () => {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
    },
};

export const services = {
    getAll: () => 
        api.get('/services/'),
    
    getById: (id) =>
        api.get(`/services/${id}/`),
    
    create: (serviceData) =>
        api.post('/services/create/', serviceData),
    
    update: (id, serviceData) =>
        api.post('/services/create/', { ...serviceData, id }),
    
    delete: (id) =>
        api.delete(`/services/${id}/`),
    
    getCategories: () =>
        api.get('/services/categories/'),
};

export const providers = {
    getAll: () =>
        api.get('/providers/'),
    
    getById: (id) =>
        api.get(`/providers/${id}/`),
    
    update: (id, providerData) =>
        api.put(`/providers/${id}/`, providerData),
    
    updateBusinessHours: (id, businessHours) =>
        api.put(`/providers/${id}/business-hours/`, { business_hours: businessHours }),
        
    setup: (businessData) =>
        api.post('/provider/setup/', businessData),
        
    getProfile: () =>
        api.get('/provider/profile/'),
    
    updateUserInfo: (userData) =>
        api.put('/auth/profile/', userData),
    
    updatePassword: (passwordData) =>
        api.put('/auth/password/', passwordData),
};

export const appointments = {
    getAll: () =>
        api.get('/appointments/'),
    
    getById: (id) =>
        api.get(`/appointments/${id}/`),
    
    create: (appointmentData) =>
        api.post('/appointments/', appointmentData),
    
    update: (id, appointmentData) =>
        api.put(`/appointments/${id}/`, appointmentData),
    
    updateStatus: (id, status) =>
        api.patch(`/appointments/${id}/status/`, { status }),
    
    delete: (id) =>
        api.delete(`/appointments/${id}/`),
        
    getAllForProvider: () =>
        api.get('/appointments/'),
};

// New API service for provider availability
export const availability = {
    // Get availability for a specific provider
    getForProvider: (providerId) => {
        console.log('Getting availability for provider:', providerId);
        return api.get(`/providers/${providerId}/availability/`);
    },
    
    // Get availability for a specific service (which includes provider info)
    getForService: (serviceId) => {
        console.log('Getting availability for service:', serviceId);
        return api.get(`/services/${serviceId}/availability/`);
    },
    
    // Save provider availability
    save: (providerId, availabilityData) => {
        console.log('Saving availability for provider:', providerId);
        console.log('Availability data being sent:', availabilityData);
        return api.post(`/providers/${providerId}/availability/`, availabilityData);
    },
    
    // Get provider profile
    getProviderProfile: () => {
        console.log('Getting provider profile');
        return api.get('/provider/profile/');
    }
};

// Export the configured axios instance for direct use
export { api }; 